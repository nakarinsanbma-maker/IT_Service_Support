<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Support Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden-section { display: none; }
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="p-4">

    <div id="loading" class="text-center mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div id="reportSection" class="hidden-section max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-red-600">üö® ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ IT</h2>
        <form onsubmit="submitForm(event, 'Report')">
            <label class="block mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: <input type="text" id="r_name" class="w-full border p-2 rounded" readonly></label>
            <label class="block mb-2">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:
                <select id="r_category" class="w-full border p-2 rounded" required>
                    <option value="Hardware">Hardware (‡∏Ñ‡∏≠‡∏°/‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå)</option>
                    <option value="Software">Software (‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°/Windows)</option>
                    <option value="Network">Network/Internet</option>
                    <option value="Peripherals">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡∏û‡πà‡∏ß‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
            </label>
            <label class="block mb-2">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢: <input type="text" id="r_dept" class="w-full border p-2 rounded" required></label>
            <label class="block mb-2">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: <textarea id="r_details" class="w-full border p-2 rounded" rows="3" required></textarea></label>
            <button type="submit" class="w-full bg-red-600 text-white p-3 rounded font-bold hover:bg-red-700">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
        </form>
    </div>

    <div id="borrowSection" class="hidden-section max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-blue-600">üì¶ ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
        <form onsubmit="submitForm(event, 'Borrow')">
            <label class="block mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: <input type="text" id="b_name" class="w-full border p-2 rounded" readonly></label>
            <label class="block mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°: <input type="text" id="b_item" class="w-full border p-2 rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå" required></label>
            <label class="block mb-2">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢: <input type="text" id="b_dept" class="w-full border p-2 rounded" required></label>
            <label class="block mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: <input type="datetime-local" id="b_date" class="w-full border p-2 rounded" required></label>
            <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏∑‡∏°</button>
        </form>
    </div>

    <div id="otherSection" class="hidden-section max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-green-600">üìù ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h2>
        <form onsubmit="submitForm(event, 'Other')">
            <label class="block mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: <input type="text" id="o_name" class="w-full border p-2 rounded" readonly></label>
            <label class="block mb-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: <input type="text" id="o_topic" class="w-full border p-2 rounded" required></label>
            <label class="block mb-2">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢: <input type="text" id="o_dept" class="w-full border p-2 rounded" required></label>
            <label class="block mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: <textarea id="o_details" class="w-full border p-2 rounded" rows="3" required></textarea></label>
            <button type="submit" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700">‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
        </form>
    </div>

    <div id="statusSection" class="hidden-section max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-purple-600">üîç ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
        <div id="statusList" class="space-y-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <button onclick="liff.closeWindow()" class="mt-4 w-full bg-gray-500 text-white p-2 rounded">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>

    <div id="successSection" class="hidden-section text-center mt-20">
        <svg class="w-20 h-20 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        <h2 class="text-2xl font-bold mt-4">‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h2>
        <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...</p>
    </div>

    <script>
        const LIFF_ID = "2008629776-KXngaa2q"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyQ5ltP3Df_bs9DLIDs-7JE_-97hZBTDyb7WxUFtyyHLzrtdtyKTwbpSblx6T5g5W3stA/exec";

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            
            const profile = await liff.getProfile();
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            document.getElementById('loading').style.display = 'none';

            // Auto fill Name
            ['r_name', 'b_name', 'o_name'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = profile.displayName;
            });

            if (mode === 'report') document.getElementById('reportSection').style.display = 'block';
            else if (mode === 'borrow') document.getElementById('borrowSection').style.display = 'block';
            else if (mode === 'other') document.getElementById('otherSection').style.display = 'block';
            else if (mode === 'status') {
                document.getElementById('statusSection').style.display = 'block';
                loadStatus(profile.userId);
            }
        }

        async function submitForm(e, type) {
            e.preventDefault();
            const profile = await liff.getProfile();
            let payload = {
                userId: profile.userId,
                displayName: profile.displayName,
                type: type,
                department: '', details: '', category: ''
            };

            if(type === 'Report') {
                payload.category = document.getElementById('r_category').value;
                payload.department = document.getElementById('r_dept').value;
                payload.details = document.getElementById('r_details').value;
            } else if (type === 'Borrow') {
                payload.category = document.getElementById('b_item').value;
                payload.department = document.getElementById('b_dept').value;
                payload.details = "‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + document.getElementById('b_date').value;
            } else if (type === 'Other') {
                payload.category = document.getElementById('o_topic').value;
                payload.department = document.getElementById('o_dept').value;
                payload.details = document.getElementById('o_details').value;
            }

            // Show Loading
            // Send to GAS
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // Important for GAS
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Show Success & Close
            document.querySelectorAll('div').forEach(d => d.style.display = 'none');
            document.getElementById('successSection').style.display = 'block';
            setTimeout(() => { liff.closeWindow(); }, 3000);
        }

        async function loadStatus(userId) {
            const res = await fetch(`${GAS_URL}?userId=${userId}`);
            const data = await res.json();
            const list = document.getElementById('statusList');
            list.innerHTML = '';
            
            if(data.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>';
                return;
            }

            data.forEach(item => {
                let color = item.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800';
                let statusText = item.status === 'Pending' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                
                list.innerHTML += `
                    <div class="border p-3 rounded flex justify-between items-center bg-white">
                        <div>
                            <div class="font-bold">${item.ticketId}</div>
                            <div class="text-sm text-gray-600">${item.type}</div>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-bold ${color}">${statusText}</span>
                    </div>
                `;
            });
        }

        main();
    </script>
</body>
</html>
